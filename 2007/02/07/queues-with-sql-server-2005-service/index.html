
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Queues With SQL Server 2005 Service Broker and C# - Fail Better</title>
  <meta name="author" content="David aka t3rse">

  
  <meta name="description" content="{I recently had to set this up and didn&#8217;t find all too many resources online. I don&#8217;t have time for a full commentary but suffices to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://t3rse.github.io/2007/02/07/queues-with-sql-server-2005-service">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Fail Better" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Fail Better</a></h1>
  
    <h2>An open letter</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:t3rse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Queues With SQL Server 2005 Service Broker and C#</h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-02-07T22:25:00-06:00" pubdate data-updated="true">Feb 7<span>th</span>, 2007</time>
        
      </p>
    
  </header>


<div class="entry-content"><div class='post'>
<span style="font-size:180%;color:#3333ff;">{</span><br /><br />I recently had to set this up and didn&#8217;t find all too many resources online.  I don&#8217;t have time for a full commentary but suffices to say this: SQL Server 2005 has some excellent reliable messaging capabilities through what&#8217;s called Service Broker.  If you, like me, are a complete skeptic when it comes to new products, this is what I think of as a compelling feature.  In the following example, I&#8217;m setting up a queue for FileIDs - assume these are identifiers for files that need to be processed asynchronously. After I created my database in SQL 2005, I opened up the query tool and went ahead with the following TSQL:<br /><br /><span style="font-family:courier new;font-size:78%;">&#8211; you can attribute an hour to finding this requirement :(<br />CREATE MASTER KEY ENCRYPTION BY PASSWORD = &#8216;Password1&#8217;;<br />GO</span><br /><span style="font-family:courier new;font-size:78%;"><br />&#8211; message, contract, queue, service creation<br />CREATE MESSAGE TYPE FileIDForQueue<br />VALIDATION = NONE;<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE CONTRACT FileQueueContract<br />(FileIDForQueue SENT BY INITIATOR)<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE QUEUE dbo.FileIDReceiverQueue<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE QUEUE dbo.FileIDSenderQueue<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE SERVICE SenderService<br />ON QUEUE dbo.FileIDSenderQueue<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE SERVICE ReceiverService<br />ON QUEUE dbo.FileIDReceiverQueue (FileQueueContract)<br />GO</span><br /><br />In order to leverage the queue, I wrote the following stored procedures to enqueue, dequeue, and peek:<br /><br /><span style="font-family:courier new;font-size:78%;">/*<br />STORED PROCEDURE RESPONSIBLE FOR INSERTING A QUEUE ITEM<br />*/<br />CREATE PROC spSendFileToQueue<br />@FileID INT<br />AS<br />BEGIN TRANSACTION;<br />DECLARE @conversationID UNIQUEIDENTIFIER<br />BEGIN DIALOG CONVERSATION @conversationID<br />FROM SERVICE SenderService<br />TO SERVICE &#8216;ReceiverService&#8217;<br />ON CONTRACT FileQueueContract;<br />SEND ON CONVERSATION @conversationID<br />MESSAGE TYPE FileIDForQueue(@fileid);<br />&#8211;END CONVERSATION @conversationID;<br />COMMIT TRANSACTION;<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">/*<br />STORED PROCEDURE RESPONSIBLE FOR RETRIEVING QUEUE ITEMS IN FIFO STYLE<br />*/<br />CREATE PROC spGetFileFromQueue<br />@FileID INT OUTPUT<br />AS<br />RECEIVE TOP(1) @FileID = CONVERT(INT, message_body) FROM FileIDReceiverQueue<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">/*<br />STORED PROCEDURE RESPONSIBLE FOR &#8220;PEEKING&#8221; INTO QUEUE<br />*/<br />CREATE PROC spPeekFileQueue<br />@FileID INT OUTPUT<br />AS<br />SELECT TOP(1) @FileID = CONVERT(INT, message_body) FROM FileIDReceiverQueue<br />WHERE message_body IS NOT NULL<br />GO</span><br /><br />Now that my stored procedures are in place, I can test in TSQL:<br /><br /><span style="font-family:courier new;font-size:78%;">&#8211; to send it to the queue:<br />spSendFileToQueue 45<br /></span><br /><span style="font-family:courier new;font-size:78%;">&#8211; peek into the queue<br />DECLARE @F INT<br />EXEC spPeekFileQueue @FileID=@F OUTPUT<br />PRINT @F<br /></span><br /><span style="font-family:courier new;font-size:78%;">&#8211; to get it back<br />DECLARE @F INT<br />EXEC spGetFileFromQueue @FileID=@F OUTPUT<br />PRINT @F</span><br /><br />From here it&#8217;s trivial to port the procedure calls to C#:<br /><br /><span style="font-family:courier new;font-size:78%;">public static void RunActionProc(string procName, SqlParameter parm) {<br />   SqlParameter[] parms = new SqlParameter[] { parm };<br />   RunActionProc(procName, parms);<br />}<br /></span><br /><span style="font-family:courier new;font-size:78%;">public static void RunActionProc(string procName, SqlParameter[] parms)<br />{<br />   SqlCommand co = new SqlCommand(procName, GetConnection(true));<br />   co.CommandType = CommandType.StoredProcedure;<br />   foreach (SqlParameter parm in parms)<br />   {<br />     co.Parameters.Add(parm);<br />    }<br />    co.ExecuteNonQuery();<br />}</span><br /><span style="font-family:courier new;font-size:78%;"></span><br /><span style="font-family:courier new;font-size:78%;">public static void Enqueue(int value)<br />{<br />    DBHelper.RunActionProc(&#8220;spSendFileToQueue&#8221;, new SqlParameter(&#8220;@FileID&#8221;, value));<br />}<br /></span><br /><span style="font-family:courier new;font-size:78%;">public static int Peek(){<br />   SqlParameter fileIdParameter = new SqlParameter(&#8220;@FileID&#8221;, SqlDbType.Int);<br />   fileIdParameter.Direction = ParameterDirection.Output;<br />   DBHelper.RunActionProc(&#8220;spPeekFileQueue&#8221;, fileIdParameter);<br />   return Convert.ToInt32(fileIdParameter.Value);<br />}<br /></span><br /><span style="font-family:courier new;font-size:78%;">public static int Dequeue() {<br />   SqlParameter fileIdParameter = new SqlParameter(&#8220;@FileID&#8221;, SqlDbType.Int);<br />   fileIdParameter.Direction = ParameterDirection.Output;<br />   DBHelper.RunActionProc(&#8220;spGetFileFromQueue&#8221;, fileIdParameter);<br />   return Convert.ToInt32(fileIdParameter.Value);<br />}</span><br /><br />A sample project in C# can be found <a href="http://hobbitwerk.brinkster.net/metadeveloper/BrokerQueue.zip">here</a>.<br /><br /><span style="font-size:180%;color:#3333ff;">}</span></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>radafanas</div>
<div class='content'>
there&#39;s something weird.. I copied and run your code but it doent work..</div>
</div>
<div class='comment'>
<div class='author'>Anurag</div>
<div class='content'>
I have one type of message, one process to input in the queue and multiple readers of the queue.  Are there any simplifications possible in your model or is it the minimum that I have to use.<BR/><BR/>Thanks.</div>
</div>
<div class='comment'>
<div class='author'>Patrick</div>
<div class='content'>
Very helpful. Thanks!</div>
</div>
<div class='comment'>
<div class='author'>Jason Nadrowski</div>
<div class='content'>
I found this helpful. Thank you.</div>
</div>
</div>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">David aka t3rse</span></span>

      








  


<time datetime="2007-02-07T22:25:00-06:00" pubdate data-updated="true">Feb 7<span>th</span>, 2007</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://t3rse.github.io/2007/02/07/queues-with-sql-server-2005-service/" data-via="t3rse" data-counturl="http://t3rse.github.io/2007/02/07/queues-with-sql-server-2005-service/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2007/02/03/future-of-programming-languages/" title="Previous Post: The Future of Programming Languages">&laquo; The Future of Programming Languages</a>
      
      
        <a class="basic-alignment right" href="/2007/02/10/vote-hanselminutes/" title="Next Post: Vote Hanselminutes">Vote Hanselminutes &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/06/20/ndc-2011/">NDC 2011</a>
      </li>
    
      <li class="post">
        <a href="/2011/06/15/search-match-replace-generate/">Search, Match, Replace, Generate</a>
      </li>
    
      <li class="post">
        <a href="/2011/06/15/on-features/">On Features</a>
      </li>
    
      <li class="post">
        <a href="/2011/06/13/closures-anonymous-javascript/">Closures, Anonymous: JavaScript Influenced C#</a>
      </li>
    
      <li class="post">
        <a href="/2011/06/10/getting-random-rows-random-numbers-with/">Getting Random Rows, Random Numbers With Sql Server</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/t3rse">@t3rse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 't3rse',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - David aka t3rse -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
