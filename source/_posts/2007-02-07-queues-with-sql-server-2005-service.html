---
layout: post
title: "Queues with SQL Server 2005 Service Broker and C#"
date: 2007-02-07T20:25:00-08:00
---

<div class='post'>
<span style="font-size:180%;color:#3333ff;">{</span><br /><br />I recently had to set this up and didn't find all too many resources online.  I don't have time for a full commentary but suffices to say this: SQL Server 2005 has some excellent reliable messaging capabilities through what's called Service Broker.  If you, like me, are a complete skeptic when it comes to new products, this is what I think of as a compelling feature.  In the following example, I'm setting up a queue for FileIDs - assume these are identifiers for files that need to be processed asynchronously. After I created my database in SQL 2005, I opened up the query tool and went ahead with the following TSQL:<br /><br /><span style="font-family:courier new;font-size:78%;">-- you can attribute an hour to finding this requirement :(<br />CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'Password1';<br />GO</span><br /><span style="font-family:courier new;font-size:78%;"><br />-- message, contract, queue, service creation<br />CREATE MESSAGE TYPE FileIDForQueue<br />VALIDATION = NONE;<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE CONTRACT FileQueueContract<br />(FileIDForQueue SENT BY INITIATOR)<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE QUEUE dbo.FileIDReceiverQueue<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE QUEUE dbo.FileIDSenderQueue<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE SERVICE SenderService<br />ON QUEUE dbo.FileIDSenderQueue<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">CREATE SERVICE ReceiverService<br />ON QUEUE dbo.FileIDReceiverQueue (FileQueueContract)<br />GO</span><br /><br />In order to leverage the queue, I wrote the following stored procedures to enqueue, dequeue, and peek:<br /><br /><span style="font-family:courier new;font-size:78%;">/*<br />STORED PROCEDURE RESPONSIBLE FOR INSERTING A QUEUE ITEM<br />*/<br />CREATE PROC spSendFileToQueue<br />@FileID INT<br />AS<br />BEGIN TRANSACTION;<br />DECLARE @conversationID UNIQUEIDENTIFIER<br />BEGIN DIALOG CONVERSATION @conversationID<br />FROM SERVICE SenderService<br />TO SERVICE 'ReceiverService'<br />ON CONTRACT FileQueueContract;<br />SEND ON CONVERSATION @conversationID<br />MESSAGE TYPE FileIDForQueue(@fileid);<br />--END CONVERSATION @conversationID;<br />COMMIT TRANSACTION;<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">/*<br />STORED PROCEDURE RESPONSIBLE FOR RETRIEVING QUEUE ITEMS IN FIFO STYLE<br />*/<br />CREATE PROC spGetFileFromQueue<br />@FileID INT OUTPUT<br />AS<br />RECEIVE TOP(1) @FileID = CONVERT(INT, message_body) FROM FileIDReceiverQueue<br />GO<br /></span><br /><span style="font-family:courier new;font-size:78%;">/*<br />STORED PROCEDURE RESPONSIBLE FOR "PEEKING" INTO QUEUE<br />*/<br />CREATE PROC spPeekFileQueue<br />@FileID INT OUTPUT<br />AS<br />SELECT TOP(1) @FileID = CONVERT(INT, message_body) FROM FileIDReceiverQueue<br />WHERE message_body IS NOT NULL<br />GO</span><br /><br />Now that my stored procedures are in place, I can test in TSQL:<br /><br /><span style="font-family:courier new;font-size:78%;">-- to send it to the queue:<br />spSendFileToQueue 45<br /></span><br /><span style="font-family:courier new;font-size:78%;">-- peek into the queue<br />DECLARE @F INT<br />EXEC spPeekFileQueue @FileID=@F OUTPUT<br />PRINT @F<br /></span><br /><span style="font-family:courier new;font-size:78%;">-- to get it back<br />DECLARE @F INT<br />EXEC spGetFileFromQueue @FileID=@F OUTPUT<br />PRINT @F</span><br /><br />From here it's trivial to port the procedure calls to C#:<br /><br /><span style="font-family:courier new;font-size:78%;">public static void RunActionProc(string procName, SqlParameter parm) {<br />   SqlParameter[] parms = new SqlParameter[] { parm };<br />   RunActionProc(procName, parms);<br />}<br /></span><br /><span style="font-family:courier new;font-size:78%;">public static void RunActionProc(string procName, SqlParameter[] parms)<br />{<br />   SqlCommand co = new SqlCommand(procName, GetConnection(true));<br />   co.CommandType = CommandType.StoredProcedure;<br />   foreach (SqlParameter parm in parms)<br />   {<br />     co.Parameters.Add(parm);<br />    }<br />    co.ExecuteNonQuery();<br />}</span><br /><span style="font-family:courier new;font-size:78%;"></span><br /><span style="font-family:courier new;font-size:78%;">public static void Enqueue(int value)<br />{<br />    DBHelper.RunActionProc("spSendFileToQueue", new SqlParameter("@FileID", value));<br />}<br /></span><br /><span style="font-family:courier new;font-size:78%;">public static int Peek(){<br />   SqlParameter fileIdParameter = new SqlParameter("@FileID", SqlDbType.Int);<br />   fileIdParameter.Direction = ParameterDirection.Output;<br />   DBHelper.RunActionProc("spPeekFileQueue", fileIdParameter);<br />   return Convert.ToInt32(fileIdParameter.Value);<br />}<br /></span><br /><span style="font-family:courier new;font-size:78%;">public static int Dequeue() {<br />   SqlParameter fileIdParameter = new SqlParameter("@FileID", SqlDbType.Int);<br />   fileIdParameter.Direction = ParameterDirection.Output;<br />   DBHelper.RunActionProc("spGetFileFromQueue", fileIdParameter);<br />   return Convert.ToInt32(fileIdParameter.Value);<br />}</span><br /><br />A sample project in C# can be found <a href="http://hobbitwerk.brinkster.net/metadeveloper/BrokerQueue.zip">here</a>.<br /><br /><span style="font-size:180%;color:#3333ff;">}</span></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>radafanas</div>
<div class='content'>
there&#39;s something weird.. I copied and run your code but it doent work..</div>
</div>
<div class='comment'>
<div class='author'>Anurag</div>
<div class='content'>
I have one type of message, one process to input in the queue and multiple readers of the queue.  Are there any simplifications possible in your model or is it the minimum that I have to use.<BR/><BR/>Thanks.</div>
</div>
<div class='comment'>
<div class='author'>Patrick</div>
<div class='content'>
Very helpful. Thanks!</div>
</div>
<div class='comment'>
<div class='author'>Jason Nadrowski</div>
<div class='content'>
I found this helpful. Thank you.</div>
</div>
</div>
