---
layout: post
title: "Pivot Tables with UDFs"
date: 2007-09-11T22:21:00-07:00
---

<div class='post'>
<h1><span style="color:#0000ff;">{</span></h1> <p>I taught a T-SQL Programming class this week and in the process looked over some old books on the subject. One in particular I've enjoyed was the <a href="http://books.google.com/books?id=JR3cOHQ8LMAC&dq=ales+spetic&amp;printsec=frontcover&source=web&amp;ots=kBadWWDPIb&sig=iBrKejm9x9E6OfDZ5McycVxOc2o#PPP1,M1">Transact-SQL Cookbook</a> from O'Reilly - I have yet to find as novel an approach to SQL, coming from the ideas of set theory rather than tutorials on querying.  I'm biased too, my best friend in highschool was Slovenian and one of the authors, Aleš Špetič, hails from that fine country.</p> <p>A cool idea from the very first chapter is the pivot table, a numeric range that can come in handy for many different types of operations.  The book, which is probably circa Microsoft SQL Server 7, demonstrates the building of a pivot table using some hardcoded insert statements followed with a cartesian join that generates the range.</p> <p>It occured to me in SQL 2000 and higher one can use a User Defined Function and get all the benefits with a little bit more flexibility.  Here is a simple approach to the same concept: </p> <p><span style="font-family:Courier New;font-size:85%;">CREATE FUNCTION fnPivot(@BOUND INT)<br />    RETURNS @Pivot TABLE(I INT)<br />AS<br />BEGIN<br />    DECLARE @I INT<br />    SET @I = 1   <br />    WHILE @I &lt;= @BOUND  BEGIN<br />        INSERT INTO @Pivot VALUES(@I)<br />        SET @I = @I + 1<br />    END<br />    RETURN<br />END<br />GO</span> </p><p>The approach is different but the benefits are similar.  A simple one from the first chapter is building a calendar of a given range of days.  I've adapted it to use the function above:</p> <p><span style="font-family:Courier New;font-size:85%;">SELECT<br />    CONVERT(CHAR(10), DATEADD(d, i, CURRENT_TIMESTAMP), 121) [date],<br />    DATENAME(dw, DATEADD(d, i, CURRENT_TIMESTAMP)) [day]<br />FROM<br />    dbo.fnPivot(7)</span>  </p><p>date       day                           <br />---------- ------------------------------<br />2007-09-13 Thursday<br />2007-09-14 Friday<br />2007-09-15 Saturday<br />2007-09-16 Sunday<br />2007-09-17 Monday<br />2007-09-18 Tuesday<br />2007-09-19 Wednesday </p><h1><span style="color:#0000ff;">}</span></h1></div>
